#!/bin/bash

# –°–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –¥–ª—è —Å–∞–π—Ç–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –¥–≤–µ—Ä–µ–π
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./setup-ssl.sh

DOMAIN="meddoors.dorren.ru"
SERVER_IP="89.23.98.187"

echo "üîí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –¥–ª—è $DOMAIN"
echo "=========================================="

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–æ–º–µ–Ω–∞
echo "üîç –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–æ–º–µ–Ω–∞..."
if ping -c 3 $DOMAIN >/dev/null 2>&1; then
    echo "‚úÖ –î–æ–º–µ–Ω $DOMAIN –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    echo "‚ö†Ô∏è –î–æ–º–µ–Ω $DOMAIN –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ IP $SERVER_IP"
    echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ DNS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ"
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ certbot
echo "üì¶ –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ certbot..."
sudo apt update -qq
sudo apt install -y certbot python3-certbot-nginx -qq

# –ü–æ–ª—É—á–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
echo "üîê –®–∞–≥ 3: –ü–æ–ª—É—á–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞..."
sudo certbot --nginx -d $DOMAIN -d www.$DOMAIN

if [ $? -eq 0 ]; then
    echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω!"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
    echo "üîç –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞..."
    sudo certbot certificates

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    echo "üîÑ –®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è..."
    sudo systemctl enable certbot.timer
    sudo systemctl start certbot.timer

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTPS
    echo "üåê –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTPS —Ä–∞–±–æ—Ç—ã..."
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç –ø–æ –∞–¥—Ä–µ—Å–∞–º:"
    echo "üîí https://$DOMAIN"
    echo "üîí https://www.$DOMAIN"

    # –¢–µ—Å—Ç HTTPS –æ—Ç–≤–µ—Ç–∞
    if curl -I https://$DOMAIN 2>/dev/null | grep -q "200"; then
        echo "‚úÖ HTTPS —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
    else
        echo "‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ HTTPS –≤—Ä—É—á–Ω—É—é: curl -I https://$DOMAIN"
    fi

    echo ""
    echo "üéâ SSL –ù–ê–°–¢–†–û–ï–ù –£–°–ü–ï–®–ù–û!"
    echo "========================="
    echo "üìã –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:"
    echo "‚úÖ Certbot —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –ø–æ–ª—É—á–µ–Ω –¥–ª—è $DOMAIN"
    echo "‚úÖ Nginx –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è HTTPS"
    echo "‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ"
    echo ""
    echo "üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏:"
    echo "sudo certbot certificates                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤"
    echo "sudo certbot renew                          # –†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ"
    echo "sudo certbot revoke --cert-name $DOMAIN     # –û—Ç–∑—ã–≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞"
    echo "sudo systemctl status certbot.timer         # –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
    echo ""
    echo "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:"
    echo "sudo tail -f /var/log/letsencrypt/letsencrypt.log"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞"
    echo ""
    echo "üîß –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:"
    echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –¥–æ–º–µ–Ω —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π IP"
    echo "2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ—Ä—Ç 80 –æ—Ç–∫—Ä—ã—Ç"
    echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ DNS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ–º–µ–Ω–∞"
    echo "4. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–ª—É—á–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤—Ä—É—á–Ω—É—é:"
    echo "   sudo certbot --nginx -d $DOMAIN"
fi