#!/bin/bash

# –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./upload-to-server.sh

SERVER_IP="89.23.98.187"

echo "üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å–∞–π—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä"
echo "================================="

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
if [ -f "dist/index.html" ]; then
    echo "‚úÖ –§–∞–π–ª—ã –Ω–∞–π–¥–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ"
    echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ dist:"
    ls -la dist/ | head -10
else
    echo "‚ùå –§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ!"
    echo "–°–Ω–∞—á–∞–ª–∞ —Å–æ–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –ª–æ–∫–∞–ª—å–Ω–æ: npm run build"
    exit 1
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞
echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞..."
ARCHIVE_NAME="medical-doors-site-$(date +%Y%m%d-%H%M%S).tar.gz"
tar -czf "$ARCHIVE_NAME" -C dist .

echo "üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ö–∏–≤–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
scp -o StrictHostKeyChecking=no "$ARCHIVE_NAME" root@$SERVER_IP:/tmp/

# –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
echo "üìã –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
ssh -o StrictHostKeyChecking=no root@$SERVER_IP << EOF
# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ nginx –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
systemctl stop nginx 2>/dev/null || echo "nginx –Ω–µ –∑–∞–ø—É—â–µ–Ω"

# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤
rm -rf /var/www/medical-doors/dist/*

# –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
cd /var/www/medical-doors/dist
tar -xzf /tmp/$ARCHIVE_NAME
chown -R www-data:www-data /var/www/medical-doors/dist
chmod -R 755 /var/www/medical-doors/dist

# –û—á–∏—Å—Ç–∫–∞ –∞—Ä—Ö–∏–≤–∞
rm /tmp/$ARCHIVE_NAME

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤
echo "üìÅ –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:"
ls -la /var/www/medical-doors/dist/

# –ó–∞–ø—É—Å–∫ nginx
systemctl start nginx

echo "‚úÖ –§–∞–π–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
EOF

# –û—á–∏—Å—Ç–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∞—Ä—Ö–∏–≤–∞
rm "$ARCHIVE_NAME"

echo ""
echo "üéâ –§–ê–ô–õ–´ –£–°–ü–ï–®–ù–û –û–ë–ù–û–í–õ–ï–ù–´!"
echo "=========================="
echo "üåê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç: https://meddoors.dorren.ru"
echo ""
echo "üìã –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:"
echo "‚úÖ –ü—Ä–æ–µ–∫—Ç –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –ø—É—Ç—è–º–∏ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º"
echo "‚úÖ –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω –∏ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä"
echo "‚úÖ –°—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã, –Ω–æ–≤—ã–µ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω—ã"
echo "‚úÖ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
echo "‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
echo ""
echo "üñºÔ∏è –¢–µ–ø–µ—Ä—å –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–æ–ª–∂–Ω—ã –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!"