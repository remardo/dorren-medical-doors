#!/bin/bash

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∞–π—Ç–∞ —Å –ø–æ–ª–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./force-update-site.sh

SERVER_IP="89.23.98.187"
DOMAIN="meddoors.dorren.ru"

echo "üî• –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∞–π—Ç–∞ —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π"
echo "==============================================="

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
echo "üîç –®–∞–≥ 1: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
echo "–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ dist:"
ls -la dist/ 2>/dev/null || echo "‚ùå –ü–∞–ø–∫–∞ dist –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"

if [ ! -f "dist/index.html" ]; then
    echo "‚ùå –§–∞–π–ª dist/index.html –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "–°–Ω–∞—á–∞–ª–∞ —Å–æ–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –ª–æ–∫–∞–ª—å–Ω–æ"
    exit 1
fi

echo "‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–π index.html –Ω–∞–π–¥–µ–Ω"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
echo "üñºÔ∏è –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π..."
if [ -d "dist/assets/images" ]; then
    IMG_COUNT=$(ls dist/assets/images/ | wc -l)
    echo "‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞–π–¥–µ–Ω—ã: $IMG_COUNT —Ñ–∞–π–ª–æ–≤"
    ls dist/assets/images/ | head -5
else
    echo "‚ùå –ü–∞–ø–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
    echo "–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å–Ω–∞—á–∞–ª–∞"
    exit 1
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
echo "üì¶ –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ —Ñ–∞–π–ª–æ–≤..."
ARCHIVE_NAME="site-full-update-$(date +%Y%m%d-%H%M%S).tar.gz"
echo "–ò–º—è –∞—Ä—Ö–∏–≤–∞: $ARCHIVE_NAME"
echo "–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤: $(du -sh dist/ | cut -f1)"

tar -czf "$ARCHIVE_NAME" -C dist .
ARCHIVE_SIZE=$(du -sh "$ARCHIVE_NAME" | cut -f1)
echo "‚úÖ –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: $ARCHIVE_SIZE"

# –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
echo "üì§ –®–∞–≥ 4: –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
echo "–ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ö–∏–≤–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
scp -o StrictHostKeyChecking=no -v "$ARCHIVE_NAME" root@$SERVER_IP:/tmp/ 2>&1 | head -10

if [ $? -eq 0 ]; then
    echo "‚úÖ –ê—Ä—Ö–∏–≤ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ö–∏–≤–∞"
    rm "$ARCHIVE_NAME"
    exit 1
fi

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
echo "üîÑ –®–∞–≥ 5: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
ssh -o StrictHostKeyChecking=no root@$SERVER_IP << EOF
echo "=== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –°–ï–†–í–ï–†–ê ==="
echo "–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: \$(date)"
echo "–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: \$(pwd)"
echo "–°—Ç–∞—Ç—É—Å nginx: \$(systemctl status nginx --no-pager -l | grep Active)"

echo ""
echo "=== –°–û–ó–î–ê–ù–ò–ï –†–ï–ó–ï–†–í–ù–û–ô –ö–û–ü–ò–ò ==="
BACKUP_DIR="/var/www/medical-doors/dist.backup.\$(date +%Y%m%d_%H%M%S)"
cp -r /var/www/medical-doors/dist \$BACKUP_DIR 2>/dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é"

echo ""
echo "=== –ü–†–û–í–ï–†–ö–ê –ê–†–•–ò–í–ê ==="
ls -la /tmp/$ARCHIVE_NAME 2>/dev/null || echo "‚ùå –ê—Ä—Ö–∏–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"

echo ""
echo "=== –û–ß–ò–°–¢–ö–ê –°–¢–ê–†–´–• –§–ê–ô–õ–û–í ==="
rm -rf /var/www/medical-doors/dist/*
echo "–°—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã"

echo ""
echo "=== –†–ê–°–ü–ê–ö–û–í–ö–ê –ù–û–í–´–• –§–ê–ô–õ–û–í ==="
cd /var/www/medical-doors/dist
tar -xzf /tmp/$ARCHIVE_NAME
echo "–§–∞–π–ª—ã —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω—ã"

echo ""
echo "=== –ü–†–û–í–ï–†–ö–ê –ù–û–í–´–• –§–ê–ô–õ–û–í ==="
ls -la /var/www/medical-doors/dist/ | head -10

echo ""
echo "=== –ü–†–û–í–ï–†–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô ==="
if [ -d "/var/www/medical-doors/dist/assets/images" ]; then
    IMG_COUNT=\$(ls assets/images/ 2>/dev/null | wc -l)
    echo "‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞–π–¥–µ–Ω—ã: \$IMG_COUNT —Ñ–∞–π–ª–æ–≤"
    ls assets/images/ | head -5
else
    echo "‚ùå –ü–∞–ø–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ—Å–ª–µ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏!"
fi

echo ""
echo "=== –£–°–¢–ê–ù–û–í–ö–ê –ü–†–ê–í –î–û–°–¢–£–ü–ê ==="
chown -R www-data:www-data /var/www/medical-doors/dist
chmod -R 755 /var/www/medical-doors/dist
echo "–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

echo ""
echo "=== –û–ß–ò–°–¢–ö–ê –ê–†–•–ò–í–ê ==="
rm /tmp/$ARCHIVE_NAME
echo "–ê—Ä—Ö–∏–≤ —É–¥–∞–ª–µ–Ω"

echo ""
echo "=== –ü–ï–†–ï–ó–ê–ü–£–°–ö NGINX ==="
nginx -t && systemctl reload nginx
echo "Nginx –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"

echo ""
echo "=== –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê ==="
echo "HTTP –æ—Ç–≤–µ—Ç:"
curl -I http://$DOMAIN 2>/dev/null | head -3

echo ""
echo "HTTPS –æ—Ç–≤–µ—Ç:"
curl -I https://$DOMAIN 2>/dev/null | head -3

echo ""
echo "=== –ü–†–û–í–ï–†–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô ==="
curl -I http://$DOMAIN/assets/images/dorren_medical_door_palata_sm.jpg 2>/dev/null | head -1 || echo "‚ùå –ö–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞"

echo ""
echo "‚úÖ –û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!"
EOF

# –û—á–∏—Å—Ç–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∞—Ä—Ö–∏–≤–∞
rm "$ARCHIVE_NAME"

echo ""
echo "üéâ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!"
echo "====================================="
echo "üåê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç: https://$DOMAIN"
echo ""
echo "üìã –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:"
echo "‚úÖ –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤"
echo "‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–∞–∑–º–µ—Ä–∞"
echo "‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º"
echo "‚úÖ –ü–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
echo "‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ HTTP –∏ HTTPS –æ—Ç–≤–µ—Ç–æ–≤"
echo ""
echo "üñºÔ∏è –¢–µ–ø–µ—Ä—å –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–æ–ª–∂–Ω—ã –æ–±–Ω–æ–≤–∏—Ç—å—Å—è!"